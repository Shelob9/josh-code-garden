<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@JoshBotDotJs"/><meta name="twitter:creator" content="@josh412"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:site_name" content="Code Meadow"/><title>Github Actions For Vercel | Code Meadow</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="I am using Jest to run tests for a [[nextjs]] site on Vercel using three strategies:

1. Import the component that a page runs and test with [[jest]] and [@testing-library](https://testing-library.com/docs/react-testing-library/intro).
2"/><meta property="og:title" content="Github Actions For Vercel"/><meta property="og:description" content="Notes about Github Actions For Vercel by Josh Pollock"/><meta name="next-head-count" content="14"/><link rel="preload" href="/_next/static/css/7d5daecceb60f8b8653f.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7d5daecceb60f8b8653f.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-932037746d5fbfa6c5b9.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.5a465c16793c1ce81103.js" as="script"/><link rel="preload" href="/_next/static/chunks/eeb0540607e8d823f414da745296801d6a447ba7.be5782a331160012741e.js" as="script"/><link rel="preload" href="/_next/static/chunks/e9acf14add5c4f122717233c5b8bc320320f96b1.4f88856bcd1b60da9b7b.js" as="script"/><link rel="preload" href="/_next/static/chunks/3a4d373e4f729ad3d1487c5b24727311a83f72b6.1e85bf9a6905759fb0eb.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-b482741977e4bf562c8e.js" as="script"/><link rel="preload" href="/_next/static/chunks/cf2f3e6cb2c7250386e9cd655729b7b20c55eb51.ac8d4cfb4548f21b4362.js" as="script"/><link rel="preload" href="/_next/static/chunks/65446de8fdf4c7aed854cb7642630d677689ed10.45e35cef76c76ec9fe95.js" as="script"/><link rel="preload" href="/_next/static/chunks/57df46b1176d072649847ada4d0bda061dd08de4.bd5700c5dc837c2b8f8a.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/notes/%5Bslug%5D-416c9a91f8be1a32d9f9.js" as="script"/></head><body><div id="__next"><div class="layout"><header id="header" role="banner"><a aria-current="page" class="" href="/"><span>Code Meadow</span></a><div class="controls"><button title="Show Graph visualisation" aria-label="Show Graph visualisation" class="graph-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" class="graph-closed"><g fill="none" stroke-width="2"><circle cx="11.733" cy="3.181" r="1.902"></circle><circle cx="16.864" cy="10.861" r="1.902"></circle><circle cx="7.47" cy="16.822" r="1.902"></circle><circle cx="3.046" cy="6.275" r="1.902"></circle><circle cx="9.372" cy="10.861" r="1.902"></circle><line x1="11.635" x2="14.655" y1="10.861" y2="10.861"></line><line x1="10" x2="10.895" y1="8.959" y2="5.573"></line><line x1="7.47" x2="4.5" y1="9.68" y2="7.5"></line><line x1="8.25" x2="8.809" y1="14.92" y2="13.088"></line></g></svg></button><label class="dark-mode-toggle" aria-label="Activate dark mode" title="Activate dark mode"><input type="checkbox" checked=""/><div></div></label></div></header><div class="note-columns-scrolling-container"><div class="note-columns-container"><div class="note-container note-open note-focus animate-pulse"><div class="note-buttons"></div><div class="note-content animate-ping h-full"><span class="animate-pulse">Loading</span><span class="animate-ping">...</span></div></div></div></div><footer class="bg-white dark:bg-gray-500 border-t border-gray-400 shadow"><div class="container mx-auto flex py-8"><div class="w-full mx-auto flex flex-wrap"><aside class="flex w-full lg:w-1/2 "><div class="px-8"><h3 class="font-bold text-gray-900"><a href="/about">About</a></h3><p class="py-4 text-gray-600 text-sm">By <!-- -->Josh Pollock<!-- -->. Built with <a href="https://digitalgardenbuilder.app/" target="_blank" rel="noopener noreferrer">Digital Garden Builder</a></p></div></aside><aside class="flex w-full lg:w-1/2 lg:justify-end lg:text-right"><div class="px-8"><h3 class="font-bold text-gray-900">Social</h3><ul class="list-reset items-center text-sm pt-3"><li><a class="inline-block text-gray-600 no-underline hover:text-gray-900 hover:underline py-1" href="https://twitter.com/@josh412">Twitter</a></li></ul></div></aside><aside class="flex w-full lg:justify-end lg:text-right"></aside></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"note":{"title":"Github Actions For Vercel","content":"I am using Jest to run tests for a [[nextjs]] site on Vercel using three strategies:\r\n\r\n1. Import the component that a page runs and test with [[jest]] and [@testing-library](https://testing-library.com/docs/react-testing-library/intro).\r\n2. Use Jest to unit test utility functions my API routes use.\r\n3. Use fetch to call the API routes and test results.\r\n\r\n## Testing Vercel API routes\r\n\r\nThis approach is inspired by [[laravel]][http testing](https://laravel.com/docs/7.x/http-tests)//laravel.com/docs/7.x/http\r\n\r\nAt first I hardcoded the URL for my current PR's preview URL into the Github action.\r\n\r\n```js\r\nlet appUrl = \"https://whatever.jpollock412.vercel.app\";\r\ntest(\"Gets a 200\", async () =\u003e {\r\n\texpect.assertions(1);\r\n\tawait fetch(`${appUrl}/api/hello`)\r\n\t\t.then((r) =\u003e {\r\n\t\t\texpect(r.status).toBe(200);\r\n\t\t})\r\n\t\t.catch((e) =\u003e console.log(e));\r\n});\r\n```\r\n\r\nThat only worked beacuse I already had the PR. It's not reusable between PRs. Also, it runs the test on the previous commit in the likely case the Github action runs before the deployment is completed. I used [this action to wait for the preview URL to update](https://github.com/patrickedqvist/wait-for-vercel-preview)\r\n\r\n## Trigger A Deployment From Another Repostiory\r\n\r\n- [Vercel Deploy Hooks](https://vercel.com/docs/more/deploy-hooks)\r\n- [Github Secrets](https://docs.github.com/en/actions/reference/encrypted-secrets)\r\n- [curl Github Action](https://github.com/marketplace/actions/github-action-for-curl)\r\n  This git repo manages content for a [garden.joshpress.net](https://garden.joshpress.net). The source code for that site is in a different repo. Pushing to that repo triggers deployment on Vercel.\r\n\r\nI set up a [build hook](https://vercel.com/docs/more/deploy-hooks) on reference and then used a Github action to call it when this repo is pushed to. I used a Github repo secret for the deploy hook URL for security. If you look through the git history of this repo, you will see a hardcoded webhook URL. Then I remembered you can do that beacuse it's public. So I revoked that webhook and made a new one for the secret.\r\n\r\n```yml\r\nname: Meadow Halloween [CD]\r\n\r\non:\r\n  push:\r\n    branches: [master]\r\n\r\njobs:\r\n  curl:\r\n    runs-on: ubuntu-latest\r\n    steps:\r\n      # Trigger vercel webhook\r\n      - name: Vercel Deploy\r\n        uses: wei/curl@master\r\n\t\twith:\r\n          args: ${{ secrets.VERCEL_DEPLOY_HOOK }}\r\n```\r\n\r\n[//begin]: # \"Autogenerated link references for markdown compatibility\"\r\n[laravel]: laravel \"Laravel\"\r\n[//end]: # \"Autogenerated link references\"\r\n","slug":"gh-actions-vercel","references":[{"slug":"laravel","url":"/notes/laravel"}]},"slug":"gh-actions-vercel"},"__N_SSG":true},"page":"/notes/[slug]","query":{"slug":"gh-actions-vercel"},"buildId":"DZWm51T4MZ0AmP5_lA0tz","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-b506a249e82f979c3e76.js"></script><script src="/_next/static/chunks/main-932037746d5fbfa6c5b9.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.5a465c16793c1ce81103.js" async=""></script><script src="/_next/static/chunks/eeb0540607e8d823f414da745296801d6a447ba7.be5782a331160012741e.js" async=""></script><script src="/_next/static/chunks/e9acf14add5c4f122717233c5b8bc320320f96b1.4f88856bcd1b60da9b7b.js" async=""></script><script src="/_next/static/chunks/3a4d373e4f729ad3d1487c5b24727311a83f72b6.1e85bf9a6905759fb0eb.js" async=""></script><script src="/_next/static/chunks/pages/_app-b482741977e4bf562c8e.js" async=""></script><script src="/_next/static/chunks/cf2f3e6cb2c7250386e9cd655729b7b20c55eb51.ac8d4cfb4548f21b4362.js" async=""></script><script src="/_next/static/chunks/65446de8fdf4c7aed854cb7642630d677689ed10.45e35cef76c76ec9fe95.js" async=""></script><script src="/_next/static/chunks/57df46b1176d072649847ada4d0bda061dd08de4.bd5700c5dc837c2b8f8a.js" async=""></script><script src="/_next/static/chunks/pages/notes/%5Bslug%5D-416c9a91f8be1a32d9f9.js" async=""></script><script src="/_next/static/DZWm51T4MZ0AmP5_lA0tz/_buildManifest.js" async=""></script><script src="/_next/static/DZWm51T4MZ0AmP5_lA0tz/_ssgManifest.js" async=""></script></body></html>