<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@JoshBotDotJs"/><meta name="twitter:creator" content="@josh412"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:site_name" content="Code Meadow"/><title>Laravel Eloquent | Code Meadow</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="- [Documentation](https://laravel.com/docs/8.x/eloquent)
- [Elqouent Performance Patterns Course](https://eloquent-course.reinink.ca/)
- [[laravel]]

## Measuring and Optimizing Queries

- Use Laravel debug bar to find slow queries.
"/><meta property="og:title" content="Laravel Eloquent"/><meta property="og:description" content="Notes about Laravel Eloquent by Josh Pollock"/><meta name="next-head-count" content="14"/><link rel="preload" href="/_next/static/css/7d5daecceb60f8b8653f.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7d5daecceb60f8b8653f.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-932037746d5fbfa6c5b9.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.5a465c16793c1ce81103.js" as="script"/><link rel="preload" href="/_next/static/chunks/eeb0540607e8d823f414da745296801d6a447ba7.be5782a331160012741e.js" as="script"/><link rel="preload" href="/_next/static/chunks/e9acf14add5c4f122717233c5b8bc320320f96b1.4f88856bcd1b60da9b7b.js" as="script"/><link rel="preload" href="/_next/static/chunks/3a4d373e4f729ad3d1487c5b24727311a83f72b6.1e85bf9a6905759fb0eb.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-b482741977e4bf562c8e.js" as="script"/><link rel="preload" href="/_next/static/chunks/cf2f3e6cb2c7250386e9cd655729b7b20c55eb51.ac8d4cfb4548f21b4362.js" as="script"/><link rel="preload" href="/_next/static/chunks/65446de8fdf4c7aed854cb7642630d677689ed10.45e35cef76c76ec9fe95.js" as="script"/><link rel="preload" href="/_next/static/chunks/57df46b1176d072649847ada4d0bda061dd08de4.bd5700c5dc837c2b8f8a.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/notes/%5Bslug%5D-416c9a91f8be1a32d9f9.js" as="script"/></head><body><div id="__next"><div class="layout"><header id="header" role="banner"><a aria-current="page" class="" href="/"><span>Code Meadow</span></a><div class="controls"><button title="Show Graph visualisation" aria-label="Show Graph visualisation" class="graph-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" class="graph-closed"><g fill="none" stroke-width="2"><circle cx="11.733" cy="3.181" r="1.902"></circle><circle cx="16.864" cy="10.861" r="1.902"></circle><circle cx="7.47" cy="16.822" r="1.902"></circle><circle cx="3.046" cy="6.275" r="1.902"></circle><circle cx="9.372" cy="10.861" r="1.902"></circle><line x1="11.635" x2="14.655" y1="10.861" y2="10.861"></line><line x1="10" x2="10.895" y1="8.959" y2="5.573"></line><line x1="7.47" x2="4.5" y1="9.68" y2="7.5"></line><line x1="8.25" x2="8.809" y1="14.92" y2="13.088"></line></g></svg></button><label class="dark-mode-toggle" aria-label="Activate dark mode" title="Activate dark mode"><input type="checkbox" checked=""/><div></div></label></div></header><div class="note-columns-scrolling-container"><div class="note-columns-container"><div class="note-container note-open note-focus animate-pulse"><div class="note-buttons"></div><div class="note-content animate-ping h-full"><span class="animate-pulse">Loading</span><span class="animate-ping">...</span></div></div></div></div><footer class="bg-white dark:bg-gray-500 border-t border-gray-400 shadow"><div class="container mx-auto flex py-8"><div class="w-full mx-auto flex flex-wrap"><aside class="flex w-full lg:w-1/2 "><div class="px-8"><h3 class="font-bold text-gray-900"><a href="/about">About</a></h3><p class="py-4 text-gray-600 text-sm">By <!-- -->Josh Pollock<!-- -->. Built with <a href="https://digitalgardenbuilder.app/" target="_blank" rel="noopener noreferrer">Digital Garden Builder</a></p></div></aside><aside class="flex w-full lg:w-1/2 lg:justify-end lg:text-right"><div class="px-8"><h3 class="font-bold text-gray-900">Social</h3><ul class="list-reset items-center text-sm pt-3"><li><a class="inline-block text-gray-600 no-underline hover:text-gray-900 hover:underline py-1" href="https://twitter.com/@josh412">Twitter</a></li></ul></div></aside><aside class="flex w-full lg:justify-end lg:text-right"></aside></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"note":{"title":"Laravel Eloquent","content":"- [Documentation](https://laravel.com/docs/8.x/eloquent)\r\n- [Elqouent Performance Patterns Course](https://eloquent-course.reinink.ca/)\r\n- [[laravel]]\r\n\r\n## Measuring and Optimizing Queries\r\n\r\n- Use Laravel debug bar to find slow queries.\r\n- If database usage is too much, start by only select columns you need.\r\n  - Can do this with relationships, using callback funciton passed to `with()`:\r\n\r\n```php\r\nPost::query()\r\n    -\u003eselect(['id', 'title'])\r\n    -\u003ewith( ['author' =\u003e function(\u0026$query){\r\n        return $query-\u003eselect( ['id', 'name' ] );\r\n    }]);\r\n```\r\n\r\nYou can use a colon instead of callback:\r\n\r\n```php\r\nPost::query()\r\n    -\u003eselect(['id', 'title'])\r\n    -\u003ewith( 'author:id,name' );\r\n```\r\n\r\n## Get A Record From A `hasMany` Relationship\r\n\r\n- Eager-loading can avoid n+1 query problems, but can lead to having to load tons of mdoels, using lots of memories.\r\n\r\nThis prevents extra queries for relationship between users and logins models, but loads every login model to do the sort.\r\n\r\n```php\r\n    @foreach( $users as $user ){\r\n        {{$user-\u003elogins()-\u003elatest()-\u003efirst()-\u003ecreated_at}}\r\n    }\r\n```\r\n\r\nUsing sub-queries allows us to add additional columns to the query based on computations of another table. Use `addSelect()` method.\r\n\r\n```php\r\n$users = User::query()\r\n    //Add a virtual column\r\n    -\u003eaddSelect( ['last_login_at' =\u003e Login::select('created_at')\r\n        //Query by the user's ID\r\n        -\u003ewhereColumn( 'user_id', 'user.id' )\r\n        -\u003elatest()\r\n        -\u003etake(1)//subqueries MUST return 1 record in MySQL.\r\n    ]);\r\n```\r\n\r\nThis will give us effectively two queries, MySQL optimizes the sub queries into one query.\r\n\r\nUse virtual column:\r\n\r\n```php\r\n{{$user-\u003elast_login_at}}\r\n```\r\n\r\nThis column is a string, not automatically casted to a Carbon instance:\r\n\r\n```php\r\n    -\u003ewithCasts(['last_login_at' =\u003e 'datetime' ] )\r\n```\r\n\r\nMoving query logic from controller to [scopes](https://laravel.com/docs/8.x/eloquent#query-scopes) in model, makes login reusable, and we can add them toghether.\r\n","slug":"laravel-eloquent","references":[{"slug":"laravel","url":"/notes/laravel"}]},"slug":"laravel-eloquent"},"__N_SSG":true},"page":"/notes/[slug]","query":{"slug":"laravel-eloquent"},"buildId":"DZWm51T4MZ0AmP5_lA0tz","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-b506a249e82f979c3e76.js"></script><script src="/_next/static/chunks/main-932037746d5fbfa6c5b9.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.5a465c16793c1ce81103.js" async=""></script><script src="/_next/static/chunks/eeb0540607e8d823f414da745296801d6a447ba7.be5782a331160012741e.js" async=""></script><script src="/_next/static/chunks/e9acf14add5c4f122717233c5b8bc320320f96b1.4f88856bcd1b60da9b7b.js" async=""></script><script src="/_next/static/chunks/3a4d373e4f729ad3d1487c5b24727311a83f72b6.1e85bf9a6905759fb0eb.js" async=""></script><script src="/_next/static/chunks/pages/_app-b482741977e4bf562c8e.js" async=""></script><script src="/_next/static/chunks/cf2f3e6cb2c7250386e9cd655729b7b20c55eb51.ac8d4cfb4548f21b4362.js" async=""></script><script src="/_next/static/chunks/65446de8fdf4c7aed854cb7642630d677689ed10.45e35cef76c76ec9fe95.js" async=""></script><script src="/_next/static/chunks/57df46b1176d072649847ada4d0bda061dd08de4.bd5700c5dc837c2b8f8a.js" async=""></script><script src="/_next/static/chunks/pages/notes/%5Bslug%5D-416c9a91f8be1a32d9f9.js" async=""></script><script src="/_next/static/DZWm51T4MZ0AmP5_lA0tz/_buildManifest.js" async=""></script><script src="/_next/static/DZWm51T4MZ0AmP5_lA0tz/_ssgManifest.js" async=""></script></body></html>