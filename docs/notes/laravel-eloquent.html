<!DOCTYPE html><html lang="en"><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@JoshBotDotJs"/><meta name="twitter:creator" content="@josh412"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:site_name" content="Code Meadow"/><title>Laravel Eloquent | Code Meadow</title><meta name="robots" content="index,follow"/><meta name="googlebot" content="index,follow"/><meta name="description" content="- [Documentation](https://laravel.com/docs/8.x/eloquent)
- [Elqouent Performance Patterns Course](https://eloquent-course.reinink.ca/)
- [[laravel]]

## Measuring and Optimizing Queries

- Use Laravel debug bar to find slow queries.
"/><meta property="og:title" content="Laravel Eloquent"/><meta property="og:description" content="Notes about Laravel Eloquent by Josh Pollock"/><meta name="next-head-count" content="14"/><link rel="preload" href="/_next/static/css/1a0493bc9fdb54ffadf8.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1a0493bc9fdb54ffadf8.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-e4ef205fca5d93de439a.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.0aee811b7a2ba0b587bf.js" as="script"/><link rel="preload" href="/_next/static/chunks/eeb0540607e8d823f414da745296801d6a447ba7.858a4b022f4a82e30045.js" as="script"/><link rel="preload" href="/_next/static/chunks/e9acf14add5c4f122717233c5b8bc320320f96b1.9770bfbcaacf48f0cbd9.js" as="script"/><link rel="preload" href="/_next/static/chunks/3a4d373e4f729ad3d1487c5b24727311a83f72b6.1b64e79295a1df5d1055.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-efb99583588027661a2b.js" as="script"/><link rel="preload" href="/_next/static/chunks/cf2f3e6cb2c7250386e9cd655729b7b20c55eb51.d50059c19d19ed2ffbbe.js" as="script"/><link rel="preload" href="/_next/static/chunks/65446de8fdf4c7aed854cb7642630d677689ed10.8064b77b3f659fccd883.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/notes/%5Bslug%5D-33ce1adf9c0915fcb744.js" as="script"/></head><body><div id="__next"><div class="layout"><header id="header" role="banner"><a aria-current="page" class="" href="/"><span>Code Meadow</span></a><div class="controls"><button title="Show Graph visualisation" aria-label="Show Graph visualisation" class="graph-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" class="graph-closed"><g fill="none" stroke-width="2"><circle cx="11.733" cy="3.181" r="1.902"></circle><circle cx="16.864" cy="10.861" r="1.902"></circle><circle cx="7.47" cy="16.822" r="1.902"></circle><circle cx="3.046" cy="6.275" r="1.902"></circle><circle cx="9.372" cy="10.861" r="1.902"></circle><line x1="11.635" x2="14.655" y1="10.861" y2="10.861"></line><line x1="10" x2="10.895" y1="8.959" y2="5.573"></line><line x1="7.47" x2="4.5" y1="9.68" y2="7.5"></line><line x1="8.25" x2="8.809" y1="14.92" y2="13.088"></line></g></svg></button><label class="dark-mode-toggle" aria-label="Activate dark mode" title="Activate dark mode"><input type="checkbox" checked=""/><div></div></label></div></header><main><div class="note-columns-scrolling-container"><div class="note-columns-container"><div class="note-container note-open note-focus animate-pulse opacity-40"><div class="note-buttons"></div><div id="" class="note-content"><h1 class="animate-pulse">Laravel Eloquent</h1><div class="prose note-markdown"><ul class="mb-4 list-inside list-disc">
<li><a href="https://laravel.com/docs/8.x/eloquent">Documentation</a></li>
<li><a href="https://eloquent-course.reinink.ca/">Elqouent Performance Patterns Course</a></li>
<li><a href="/notes/laravel">laravel</a></li>
</ul>
<h2 class="mb-4"> <!-- -->Measuring and Optimizing Queries</h2>
<ul class="mb-4 list-inside list-disc">
<li>Use Laravel debug bar to find slow queries.</li>
<li>If database usage is too much, start by only select columns you need.<!-- -->
<ul class="mb-4 list-inside list-disc">
<li>Can do this with relationships, using callback funciton passed to <code>with()</code>:</li>
</ul>
</li>
</ul>
<pre><code>Post::query()
    -&gt;select([&#x27;id&#x27;, &#x27;title&#x27;])
    -&gt;with( [&#x27;author&#x27; =&gt; function(&amp;$query){
        return $query-&gt;select( [&#x27;id&#x27;, &#x27;name&#x27; ] );
    }]);
</code></pre>
<p class="mb-4"> <!-- -->You can use a colon instead of callback:</p>
<pre><code>Post::query()
    -&gt;select([&#x27;id&#x27;, &#x27;title&#x27;])
    -&gt;with( &#x27;author:id,name&#x27; );
</code></pre>
<h2 class="mb-4"> <!-- -->Get A Record From A <code>hasMany</code> Relationship</h2>
<ul class="mb-4 list-inside list-disc">
<li>Eager-loading can avoid n+1 query problems, but can lead to having to load tons of mdoels, using lots of memories.</li>
</ul>
<p class="mb-4"> <!-- -->This prevents extra queries for relationship between users and logins models, but loads every login model to do the sort.</p>
<pre><code>    @foreach( $users as $user ){
        {{$user-&gt;logins()-&gt;latest()-&gt;first()-&gt;created_at}}
    }
</code></pre>
<p class="mb-4"> <!-- -->Using sub-queries allows us to add additional columns to the query based on computations of another table. Use <code>addSelect()</code> method.</p>
<pre><code>$users = User::query()
    //Add a virtual column
    -&gt;addSelect( [&#x27;last_login_at&#x27; =&gt; Login::select(&#x27;created_at&#x27;)
        //Query by the user&#x27;s ID
        -&gt;whereColumn( &#x27;user_id&#x27;, &#x27;user.id&#x27; )
        -&gt;latest()
        -&gt;take(1)//subqueries MUST return 1 record in MySQL.
    ]);
</code></pre>
<p class="mb-4"> <!-- -->This will give us effectively two queries, MySQL optimizes the sub queries into one query.</p>
<p class="mb-4"> <!-- -->Use virtual column:</p>
<pre><code>{{$user-&gt;last_login_at}}
</code></pre>
<p class="mb-4"> <!-- -->This column is a string, not automatically casted to a Carbon instance:</p>
<pre><code>    -&gt;withCasts([&#x27;last_login_at&#x27; =&gt; &#x27;datetime&#x27; ] )
</code></pre>
<p class="mb-4"> <!-- -->Moving query logic from controller to <a href="https://laravel.com/docs/8.x/eloquent#query-scopes">scopes</a> in model, makes login reusable, and we can add them toghether.</p></div></div></div><div id="" class="note-content"></div><div id="" class="note-content"></div></div></div></main><footer class="bg-white dark:bg-gray-300 border-t border-gray-500 shadow"><div class="container mx-auto flex py-8"><div class="w-full mx-auto flex flex-wrap"><div class="flex w-full lg:w-1/2 "><div class="px-8"><h3 class="font-bold text-gray-900"><a href="/about">About</a></h3><p class="py-4 text-gray-600 text-sm">By <!-- -->Josh Pollock<!-- -->. Built with <a href="https://digitalgardenbuilder.app/" target="_blank" rel="noopener noreferrer">Digital Garden Builder</a></p></div></div><div class="flex w-full lg:w-1/2 lg:justify-end lg:text-right"><div class="px-8"><h3 class="font-bold text-gray-900">Social</h3><ul class="list-reset items-center text-sm pt-3"><li><a class="inline-block text-gray-600 no-underline hover:text-gray-900 hover:underline py-1" href="https://twitter.com/@josh412">Twitter</a></li></ul></div></div><div class="flex w-full lg:justify-end lg:text-right"></div></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"note":{"title":"Laravel Eloquent","content":"- [Documentation](https://laravel.com/docs/8.x/eloquent)\r\n- [Elqouent Performance Patterns Course](https://eloquent-course.reinink.ca/)\r\n- [[laravel]]\r\n\r\n## Measuring and Optimizing Queries\r\n\r\n- Use Laravel debug bar to find slow queries.\r\n- If database usage is too much, start by only select columns you need.\r\n  - Can do this with relationships, using callback funciton passed to `with()`:\r\n\r\n```php\r\nPost::query()\r\n    -\u003eselect(['id', 'title'])\r\n    -\u003ewith( ['author' =\u003e function(\u0026$query){\r\n        return $query-\u003eselect( ['id', 'name' ] );\r\n    }]);\r\n```\r\n\r\nYou can use a colon instead of callback:\r\n\r\n```php\r\nPost::query()\r\n    -\u003eselect(['id', 'title'])\r\n    -\u003ewith( 'author:id,name' );\r\n```\r\n\r\n## Get A Record From A `hasMany` Relationship\r\n\r\n- Eager-loading can avoid n+1 query problems, but can lead to having to load tons of mdoels, using lots of memories.\r\n\r\nThis prevents extra queries for relationship between users and logins models, but loads every login model to do the sort.\r\n\r\n```php\r\n    @foreach( $users as $user ){\r\n        {{$user-\u003elogins()-\u003elatest()-\u003efirst()-\u003ecreated_at}}\r\n    }\r\n```\r\n\r\nUsing sub-queries allows us to add additional columns to the query based on computations of another table. Use `addSelect()` method.\r\n\r\n```php\r\n$users = User::query()\r\n    //Add a virtual column\r\n    -\u003eaddSelect( ['last_login_at' =\u003e Login::select('created_at')\r\n        //Query by the user's ID\r\n        -\u003ewhereColumn( 'user_id', 'user.id' )\r\n        -\u003elatest()\r\n        -\u003etake(1)//subqueries MUST return 1 record in MySQL.\r\n    ]);\r\n```\r\n\r\nThis will give us effectively two queries, MySQL optimizes the sub queries into one query.\r\n\r\nUse virtual column:\r\n\r\n```php\r\n{{$user-\u003elast_login_at}}\r\n```\r\n\r\nThis column is a string, not automatically casted to a Carbon instance:\r\n\r\n```php\r\n    -\u003ewithCasts(['last_login_at' =\u003e 'datetime' ] )\r\n```\r\n\r\nMoving query logic from controller to [scopes](https://laravel.com/docs/8.x/eloquent#query-scopes) in model, makes login reusable, and we can add them toghether.\r\n","slug":"laravel-eloquent","references":[{"slug":"laravel","url":"/notes/laravel"}]},"slug":"laravel-eloquent"},"__N_SSG":true},"page":"/notes/[slug]","query":{"slug":"laravel-eloquent"},"buildId":"hR6cOWs3MkZ9R1_XY-rlh","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-1031cf0bba78a873b9b2.js"></script><script src="/_next/static/chunks/main-e4ef205fca5d93de439a.js" async=""></script><script src="/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="/_next/static/chunks/framework.0aee811b7a2ba0b587bf.js" async=""></script><script src="/_next/static/chunks/eeb0540607e8d823f414da745296801d6a447ba7.858a4b022f4a82e30045.js" async=""></script><script src="/_next/static/chunks/e9acf14add5c4f122717233c5b8bc320320f96b1.9770bfbcaacf48f0cbd9.js" async=""></script><script src="/_next/static/chunks/3a4d373e4f729ad3d1487c5b24727311a83f72b6.1b64e79295a1df5d1055.js" async=""></script><script src="/_next/static/chunks/pages/_app-efb99583588027661a2b.js" async=""></script><script src="/_next/static/chunks/cf2f3e6cb2c7250386e9cd655729b7b20c55eb51.d50059c19d19ed2ffbbe.js" async=""></script><script src="/_next/static/chunks/65446de8fdf4c7aed854cb7642630d677689ed10.8064b77b3f659fccd883.js" async=""></script><script src="/_next/static/chunks/pages/notes/%5Bslug%5D-33ce1adf9c0915fcb744.js" async=""></script><script src="/_next/static/hR6cOWs3MkZ9R1_XY-rlh/_buildManifest.js" async=""></script><script src="/_next/static/hR6cOWs3MkZ9R1_XY-rlh/_ssgManifest.js" async=""></script></body></html>