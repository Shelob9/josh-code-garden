{"pageProps":{"note":{"title":"Github Actions For Vercel","content":"I am using Jest to run tests for a [[nextjs]] site on Vercel using three strategies:\r\n\r\n1. Import the component that a page runs and test with [[jest]] and [@testing-library](https://testing-library.com/docs/react-testing-library/intro).\r\n2. Use Jest to unit test utility functions my API routes use.\r\n3. Use fetch to call the API routes and test results.\r\n\r\n## Testing Vercel API routes\r\n\r\nThis approach is inspired by [[laravel]][http testing](https://laravel.com/docs/7.x/http-tests)//laravel.com/docs/7.x/http\r\n\r\nAt first I hardcoded the URL for my current PR's preview URL into the Github action.\r\n\r\n```js\r\nlet appUrl = \"https://whatever.jpollock412.vercel.app\";\r\ntest(\"Gets a 200\", async () => {\r\n\texpect.assertions(1);\r\n\tawait fetch(`${appUrl}/api/hello`)\r\n\t\t.then((r) => {\r\n\t\t\texpect(r.status).toBe(200);\r\n\t\t})\r\n\t\t.catch((e) => console.log(e));\r\n});\r\n```\r\n\r\nThat only worked beacuse I already had the PR. It's not reusable between PRs. Also, it runs the test on the previous commit in the likely case the Github action runs before the deployment is completed. I used [this action to wait for the preview URL to update](https://github.com/patrickedqvist/wait-for-vercel-preview)\r\n\r\n## Trigger A Deployment From Another Repostiory\r\n\r\n- [Vercel Deploy Hooks](https://vercel.com/docs/more/deploy-hooks)\r\n- [Github Secrets](https://docs.github.com/en/actions/reference/encrypted-secrets)\r\n- [curl Github Action](https://github.com/marketplace/actions/github-action-for-curl)\r\n  This git repo manages content for a [garden.joshpress.net](https://garden.joshpress.net). The source code for that site is in a different repo. Pushing to that repo triggers deployment on Vercel.\r\n\r\nI set up a [build hook](https://vercel.com/docs/more/deploy-hooks) on reference and then used a Github action to call it when this repo is pushed to. I used a Github repo secret for the deploy hook URL for security. If you look through the git history of this repo, you will see a hardcoded webhook URL. Then I remembered you can do that beacuse it's public. So I revoked that webhook and made a new one for the secret.\r\n\r\n```yml\r\nname: Meadow Halloween [CD]\r\n\r\non:\r\n  push:\r\n    branches: [master]\r\n\r\njobs:\r\n  curl:\r\n    runs-on: ubuntu-latest\r\n    steps:\r\n      # Trigger vercel webhook\r\n      - name: Vercel Deploy\r\n        uses: wei/curl@master\r\n\t\twith:\r\n          args: ${{ secrets.VERCEL_DEPLOY_HOOK }}\r\n```\r\n\r\n[//begin]: # \"Autogenerated link references for markdown compatibility\"\r\n[laravel]: laravel \"Laravel\"\r\n[//end]: # \"Autogenerated link references\"\r\n","slug":"gh-actions-vercel","references":[{"slug":"laravel","url":"/notes/laravel"}]},"slug":"gh-actions-vercel"},"__N_SSG":true}